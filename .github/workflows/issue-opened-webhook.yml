name: Issue Opened Webhook

on:
  workflow_dispatch:
  issues:
    types: [opened]

jobs:
  create-structured-ticket:
    runs-on: ubuntu-latest
    
    steps:
      - name: Send webhook notification
        run: |
          WEBHOOK_URL="${{ vars.WEBHOOK_ISSUE_CREATION_URL }}"
          
          # Build JSON payload with issue ID and repository information
          PAYLOAD=$(jq -n \
            --argjson issue_id "${{ github.event.issue.number }}" \
            --arg repository_name "${{ github.event.repository.name }}" \
            --arg repository_owner "${{ github.event.repository.owner.login }}" \
            '{
              issue_id: $issue_id,
              repository_name: $repository_name,
              repository_owner: $repository_owner
            }')
          
          # Send the webhook with basic authentication
          curl -X POST "$WEBHOOK_URL" \
            -u "${{ vars.WEBHOOK_USERNAME }}:${{ secrets.WEBHOOK_PASSWORD }}" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            --fail \
            --silent \
            --show-error
          
          echo "Webhook sent successfully for issue #${{ github.event.issue.number }}"
      
      - name: React with rocket
        if: success()
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          reactions: "rocket"
